<!doctype html>
<html lang="ru">
  <head>
    <!-- продолжаем -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Arconique · Каталог / Админ / Калькулятор</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <link rel="icon" href="data:," />
    <style>
      /* Бежево-белая палитра для вашего CSS (перекрывает цвета) */
      :root{
        --bg: #faf8f2;
        --card: #ffffff;
        --card-hover: #f6f3ec;
        --card-active: #efe9dd;
        --line: #e7e2d9;
        --line-hover: #d9d2c6;

        --muted: #7a7a74;
        --ink: #262626;
        --ink-secondary: #565656;

        --primary: #2f2a25;
        --primary-hover: #1f1b17;
        --success: #0f766e;
        --success-hover: #115e59;
        --warning: #b45309;
        --warning-hover: #92400e;
        --danger: #b91c1c;
        --danger-hover: #991b1b;

        --accent: #3a342e;
        --accent-hover: #2c2722;

        --radius: 16px;
        --radius-sm: 8px;
        --radius-lg: 24px;

        --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.04);
        --shadow: 0 4px 10px rgba(0,0,0,0.06);
        --shadow-md: 0 10px 20px rgba(0,0,0,0.08);
        --shadow-lg: 0 20px 30px rgba(0,0,0,0.10);
        --shadow-xl: 0 25px 50px rgba(0,0,0,0.12);

        --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-bounce: 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);

        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-2xl: 48px;

        --block-min-height: 200px;
        --block-max-height: 600px;

        --z-base: 1;
        --z-card: 10;
        --z-modal: 1000;
        --z-tooltip: 1100;
        --z-notification: 1200;
      }
      body{background: var(--bg); color: var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
      /* Вставляю структуру вашего CSS (сжатую) */
      .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
      .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);transition:all var(--transition-normal)}
      .card:hover{background:var(--card-hover);border-color:var(--line-hover);transform:translateY(-2px);box-shadow:var(--shadow-md)}
      .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--line)}
      .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:20px 0}
      .kpi{display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:16px;border:1px solid var(--line);border-radius:var(--radius-sm);background:var(--card)}
      .kpi .muted{font-size:.9em;color:var(--muted);margin-bottom:8px}
      .kpi .v{font-size:1.2em;font-weight:700;color:var(--accent)}
      .calc-table th,.calc-table td{padding:14px 12px;text-align:center;border-bottom:1px solid var(--line)}
      .stages-table{width:100%;border:1px solid var(--line);border-radius:var(--radius-sm)}
      .stages-table th,.stages-table td{padding:8px;text-align:center;border-bottom:1px solid var(--line)}
      .factors-table{width:100%;border-collapse:collapse}
      .factors-table th,.factors-table td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:center}
      .cashflow-table{width:100%;border-collapse:collapse}
      .cashflow-table th,.cashflow-table td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left}
      .pill{padding:6px 12px;border-radius:999px;background:#fff;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    </style>
  </head>
  <body class="bg-white">
    <div id="root" class="wrap"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;
      const { createRoot } = ReactDOM;

      const PIN_CODE = "334346";
      const LS_CATALOG = "arq_catalog_v3";

      const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
      const fmtInt = (n) => new Intl.NumberFormat("ru-RU", { maximumFractionDigits: 0 }).format(Math.round(n || 0));
      const fmt2 = (n) => new Intl.NumberFormat("ru-RU", { maximumFractionDigits: 2 }).format(+n || 0);

      function useHashRoute() {
        const parse = () => {
          const hash = window.location.hash || "#/catalog";
          const [path, q] = hash.split("?");
          const params = {};
          if (q) q.split("&").forEach(s => { const [k,v] = s.split("="); params[decodeURIComponent(k)] = decodeURIComponent(v||""); });
          return { path, params };
        };
        const [route, setRoute] = useState(parse());
        useEffect(() => { const onHash = () => setRoute(parse()); window.addEventListener("hashchange", onHash); return () => window.removeEventListener("hashchange", onHash); }, []);
        return route;
      }

      function defaults() {
        return [
          {
            projectId: "ahau-gardens",
            projectName: "Ahau Gardens by Arconique",
            theme: "light",
            includes: ["Полная комплектация (под ключ)", "Налог с продаж 10%", "Нотариальные 1%", "График платежей: 30%+30%+25%+10%+5%"],
            villas: [
              { villaId: "ahau-a1-2br", name: "A1", status: "hold", rooms: "2", land: 201.7, area: 142.7, f1: 107.1, f2: 38.89, roof: 0, garden: 57.5, ppsm: 2200, baseUSD: 282828, monthlyPriceGrowthPct: 2, leaseholdEndDate: "2055-01-01", dailyRateUSD: 220, rentalPriceIndexPct: 5 },
              { villaId: "ahau-a6-2br", name: "A6", status: "reserved", rooms: "2", land: 201.7, area: 142.7, f1: 107.1, f2: 38.89, roof: 0, garden: 57.5, ppsm: 2250, baseUSD: 289229, monthlyPriceGrowthPct: 2, leaseholdEndDate: "2055-01-01", dailyRateUSD: 230, rentalPriceIndexPct: 5 }
            ]
          },
          {
            projectId: "enso-villas",
            projectName: "ENSO by Arconique",
            theme: "light",
            includes: ["Полная комплектация (под ключ)", "Налог с продаж 10%", "Нотариальные 1%", "График платежей: 30%+30%+25%+10%+5%"],
            villas: [
              { villaId: "enso-l1-2br", name: "L1", status: "hold", rooms: "2", land: 174.6, area: 104.1, f1: 0, f2: 0, roof: 0, garden: 40.73, ppsm: 2410, baseUSD: 244775, monthlyPriceGrowthPct: 2, leaseholdEndDate: "2054-12-01", dailyRateUSD: 220, rentalPriceIndexPct: 5 },
              { villaId: "enso-v1-2br", name: "V1", status: "hold", rooms: "2", land: 165.8, area: 114.1, f1: 0, f2: 0, roof: 0, garden: 43.4, ppsm: 2549, baseUSD: 262018, monthlyPriceGrowthPct: 2, leaseholdEndDate: "2054-12-01", dailyRateUSD: 230, rentalPriceIndexPct: 5 }
            ]
          }
        ];
      }

      function loadCatalog() {
        try { const raw = localStorage.getItem(LS_CATALOG); if (!raw) return defaults(); const parsed = JSON.parse(raw); return Array.isArray(parsed)?parsed:defaults(); } catch { return defaults(); }
      }
      function saveCatalog(c){ try{ localStorage.setItem(LS_CATALOG, JSON.stringify(c)); }catch{} }

      function Header() {
        return (
          <header className="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-neutral-200">
            <div className="mx-auto max-w-7xl px-5 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="h-9 w-9 rounded-2xl bg-neutral-900 text-white grid place-items-center font-semibold">A</div>
                <div className="leading-tight">
                  <div className="font-semibold">Arconique</div>
                  <div className="text-xs text-neutral-500">Каталог · Админ · Калькулятор</div>
                </div>
              </div>
              <nav className="flex items-center gap-3 text-sm">
                <a href="#/catalog" className="px-3 py-1.5 rounded-lg border hover:bg-neutral-50">Каталог</a>
                <a href="#/admin" className="px-3 py-1.5 rounded-lg border hover:bg-neutral-50">Админ</a>
              </nav>
            </div>
          </header>
        );
      }
      function Th({ children }) { return <th className="px-2 py-2 md:px-3 md:py-3 text-left font-medium align-top whitespace-normal leading-snug">{children}</th>; }
      function Td({ children, className="" }) { return <td className={`px-2 py-2 md:px-3 md:py-3 align-top leading-snug ${className}`}>{children}</td>; }
      function StatusPill({ value }) {
        const map = { available: "bg-emerald-100 text-emerald-800", reserved: "bg-amber-100 text-amber-800", hold: "bg-slate-100 text-slate-700" };
        const label = value==="available"?"Доступно": value==="reserved"?"Забронировано":"На паузе";
        return <span className={`px-2 py-1 rounded-xl text-xs inline-block w-[120px] text-center ${map[value]||"bg-slate-100 text-slate-700"}`}>{label}</span>;
      }

      function AdminGate({ onLogin }) {
        const [pin, setPin] = useState(""); const [err, setErr] = useState("");
        return (
          <div className="card">
            <div className="card-header"><h3>Вход в админ‑панель</h3></div>
            <div className="grid gap-3">
              <label className="grid gap-1">
                <span className="text-sm text-neutral-600">PIN</span>
                <input className="px-3 py-2 rounded-xl border" type="password" value={pin} onChange={(e)=>setPin(e.target.value)} />
              </label>
              {err && <div className="text-red-600 text-sm">{err}</div>}
              <div className="flex gap-2">
                <button className="px-4 py-2 rounded-xl bg-neutral-900 text-white" onClick={()=> pin===PIN_CODE ? onLogin() : setErr("Неверный PIN")}>Войти</button>
                <a className="px-4 py-2 rounded-xl border" href="#/catalog">Назад</a>
              </div>
            </div>
          </div>
        );
      }

      function VillaModal({ open, onClose, onSave, initial }) {
        const [form, setForm] = useState(initial || {});
        useEffect(()=> setForm(initial||{}), [initial]);
        const set = (k,v) => setForm(s=>({...s, [k]:v}));
        if (!open) return null;
        return (
          <div className="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm grid place-items-center p-4" onMouseDown={onClose}>
            <div className="w-full max-w-3xl rounded-2xl bg-white shadow-xl" onMouseDown={(e)=>e.stopPropagation()}>
              <div className="flex items-center justify-between p-4 border-b">
                <div>
                  <h3 className="text-lg font-semibold">{initial?.villaId ? "Редактировать виллу" : "Добавить виллу"}</h3>
                  <div className="text-xs text-neutral-500">Укажите все параметры для каталога и финмодели</div>
                </div>
                <button className="text-neutral-500 hover:text-black" onClick={onClose}>✕</button>
              </div>
              <div className="p-4 grid gap-4">
                <div className="grid md:grid-cols-3 gap-3">
                  <label className="grid gap-1">
                    <span className="text-sm text-neutral-600">Название (Villa type)</span>
                    <input className="px-3 py-2 rounded-xl border" value={form.name||""} onChange={(e)=>set("name", e.target.value)} />
                  </label>
                  <label className="grid gap-1">
                    <span className="text-sm text-neutral-600">Статус</span>
                    <select className="px-3 py-2 rounded-xl border" value={form.status||"available"} onChange={(e)=>set("status", e.target.value)}>
                      <option value="available">Доступно</option>
                      <option value="reserved">Забронировано</option>
                      <option value="hold">На паузе</option>
                    </select>
                  </label>
                  <label className="grid gap-1">
                    <span className="text-sm text-neutral-600">Комнат (Q Rooms)</span>
                    <input className="px-3 py-2 rounded-xl border" value={form.rooms||""} onChange={(e)=>set("rooms", e.target.value)} />
                  </label>
                </div>

                <div className="grid md:grid-cols-6 gap-3">
                  <Num label="Земля, м²" value={form.land} set={(v)=>set("land", v)} />
                  <Num label="Вилла, м²" value={form.area} set={(v)=>set("area", v)} />
                  <Num label="1 этаж, м²" value={form.f1} set={(v)=>set("f1", v)} />
                  <Num label="2 этаж, м²" value={form.f2} set={(v)=>set("f2", v)} />
                  <Num label="Руфтоп, м²" value={form.roof} set={(v)=>set("roof", v)} />
                  <Num label="Сад+бассейн, м²" value={form.garden} set={(v)=>set("garden", v)} />
                </div>

                <div className="grid md:grid-cols-4 gap-3">
                  <Num label="$ / м²" value={form.ppsm} set={(v)=>set("ppsm", v)} />
                  <Num label="База, $" value={form.baseUSD} set={(v)=>set("baseUSD", v)} />
                  <Num label="Рост до ключей, %/мес" value={form.monthlyPriceGrowthPct} set={(v)=>set("monthlyPriceGrowthPct", v)} />
                  <label className="grid gap-1">
                    <span className="text-sm text-neutral-600">Лизхолд до (YYYY-MM-DD)</span>
                    <input className="px-3 py-2 rounded-xl border" value={form.leaseholdEndDate||""} onChange={(e)=>set("leaseholdEndDate", e.target.value)} />
                  </label>
                </div>

                <div className="grid md:grid-cols-3 gap-3">
                  <Num label="Ночь, $" value={form.dailyRateUSD} set={(v)=>set("dailyRateUSD", v)} />
                  <Num label="Индекс аренды %/год" value={form.rentalPriceIndexPct} set={(v)=>set("rentalPriceIndexPct", v)} />
                </div>
              </div>
              <div className="flex items-center justify-end gap-2 p-4 border-t">
                <button className="px-3 py-2 rounded-xl border" onClick={onClose}>Отмена</button>
                <button className="px-3 py-2 rounded-xl bg-neutral-900 text-white" onClick={()=>{
                  const data = { ...form };
                  const area = +data.area || 0, ppsm = +data.ppsm || 0, base = +data.baseUSD || 0;
                  if (!ppsm && base && area) data.ppsm = Math.round(base/area);
                  if (!base && ppsm && area) data.baseUSD = Math.round(ppsm*area);
                  onSave(data);
                }}>Сохранить</button>
              </div>
            </div>
          </div>
        );
      }
      function Num({ label, value, set }) {
        const [txt, setTxt] = useState(value ?? "");
        useEffect(()=> setTxt(value ?? ""), [value]);
        return (
          <label className="grid gap-1">
            <span className="text-sm text-neutral-600">{label}</span>
            <input inputMode="decimal" className="px-3 py-2 rounded-xl border" value={txt} onChange={(e)=>{ setTxt(e.target.value); set(e.target.value===""? null : +e.target.value); }}/>
          </label>
        );
      }

      function AdminPanel({ catalog, setCatalog }) {
        const [showAddProject, setShowAddProject] = useState(false);
        const [newProjectName, setNewProjectName] = useState("");
        const [villaModal, setVillaModal] = useState({ open:false, projectId:null, init:null });
        const fileRef = useRef(null);

        const addProject = () => {
          const name = (newProjectName||"").trim();
          if (!name) return;
          const projectId = name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");
          if (catalog.some(p=>p.projectId===projectId)) { alert("Проект с таким ID уже есть"); return; }
          const next = [...catalog, { projectId, projectName: name, theme:"light", includes:[], villas: [] }];
          setCatalog(next); saveCatalog(next); setNewProjectName(""); setShowAddProject(false);
        };

        const openAddVilla = (projectId) => setVillaModal({ open:true, projectId, init:{ status:"available", monthlyPriceGrowthPct:2, rentalPriceIndexPct:5 }});
        const openEditVilla = (projectId, v) => setVillaModal({ open:true, projectId, init:{ ...v } });

        const saveVilla = (data) => {
          const projectId = villaModal.projectId;
          if (!projectId) return;
          const name = (data.name||"").trim();
          if (!name) { alert("Введите название виллы"); return; }

          const next = catalog.map(p=>{
            if (p.projectId !== projectId) return p;
            const villaId = data.villaId || (projectId+"-"+name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""));
            const exists = p.villas.some(v=>v.villaId===villaId);
            const record = { ...data, villaId };
            return { ...p, villas: exists ? p.villas.map(v=> v.villaId===villaId ? record : v) : [...p.villas, record] };
          });
          setCatalog(next); saveCatalog(next); setVillaModal({ open:false, projectId:null, init:null });
        };

        const deleteVilla = (projectId, villaId) => {
          if (!confirm("Удалить виллу?")) return;
          const next = catalog.map(p=> p.projectId===projectId ? { ...p, villas: p.villas.filter(v=>v.villaId!==villaId) } : p);
          setCatalog(next); saveCatalog(next);
        };
        const deleteProject = (projectId) => {
          if (!confirm("Удалить проект и все виллы?")) return;
          const next = catalog.filter(p=>p.projectId!==projectId);
          setCatalog(next); saveCatalog(next);
        };

        const exportJSON = () => {
          const blob = new Blob([JSON.stringify(catalog,null,2)], {type:"application/json"});
          const url = URL.createObjectURL(blob); const a = document.createElement("a");
          a.href=url; a.download=`arconique_catalog_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
        };
        const importJSON = (file) => {
          if (!file) return;
          file.text().then(txt=>{
            try {
              const data = JSON.parse(txt);
              if (!Array.isArray(data)) throw new Error("Неверный формат");
              setCatalog(data); saveCatalog(data);
            } catch(e){ alert("Ошибка импорта: "+e.message); }
          });
        };

        return (
          <div>
            <div className="card">
              <div className="card-header"><h3>Админ‑панель</h3>
                <div className="card-actions">
                  <button className="btn" onClick={()=>setShowAddProject(true)}>Добавить проект</button>
                  <button className="btn" onClick={exportJSON}>Экспорт JSON</button>
                  <label className="btn cursor-pointer">Импорт JSON<input ref={fileRef} type="file" accept="application/json,.json" className="hidden" onChange={(e)=>importJSON(e.target.files?.[0])}/></label>
                  <a className="btn" href="#/catalog">Выйти</a>
                </div>
              </div>
              {showAddProject && (
                <div className="grid md:grid-cols-2 gap-3">
                  <label className="grid gap-1">
                    <span className="text-sm text-neutral-600">Название проекта</span>
                    <input className="px-3 py-2 rounded-xl border" value={newProjectName} onChange={(e)=>setNewProjectName(e.target.value)} />
                  </label>
                  <div className="flex items-end gap-2">
                    <button className="btn primary" onClick={addProject}>Сохранить</button>
                    <button className="btn" onClick={()=>setShowAddProject(false)}>Отмена</button>
                  </div>
                </div>
              )}
            </div>

            {catalog.map(project=>(
              <section key={project.projectId} className="card">
                <div className="card-header">
                  <h3>{project.projectName}</h3>
                  <div className="card-actions">
                    <button className="btn success" onClick={()=>openAddVilla(project.projectId)}>Добавить виллу</button>
                    <button className="btn danger" onClick={()=>deleteProject(project.projectId)}>Удалить проект</button>
                  </div>
                </div>

                {project.includes?.length>0 && (
                  <ul className="text-sm text-neutral-700 mb-3">
                    {project.includes.map((x,i)=><li key={i}>• {x}</li>)}
                  </ul>
                )}

                <div className="overflow-x-auto">
                  <table className="w-full text-[clamp(11px,0.9vw,14px)] min-w-[1200px]">
                    <thead>
                      <tr className="bg-neutral-50">
                        <Th>Вилла</Th><Th>Q Rooms</Th><Th>Земля, м²</Th><Th>Вилла, м²</Th><Th>1 этаж, м²</Th><Th>2 этаж, м²</Th><Th>Руфтоп, м²</Th><Th>Сад+бассейн, м²</Th>
                        <Th>$ / м²</Th><Th>База, $</Th><Th>Статус</Th><Th><span className="inline-block w-[180px]">Действия</span></Th>
                      </tr>
                    </thead>
                    <tbody>
                      {project.villas.map(v=>(
                        <tr key={v.villaId} className="border-t">
                          <Td className="whitespace-nowrap">{v.name}</Td>
                          <Td>{v.rooms||""}</Td>
                          <Td>{v.land!=null? fmt2(v.land) : ""}</Td>
                          <Td>{v.area!=null? fmt2(v.area) : ""}</Td>
                          <Td>{v.f1!=null? fmt2(v.f1) : ""}</Td>
                          <Td>{v.f2!=null? fmt2(v.f2) : ""}</Td>
                          <Td>{v.roof!=null? fmt2(v.roof) : ""}</Td>
                          <Td>{v.garden!=null? fmt2(v.garden) : ""}</Td>
                          <Td>{v.ppsm!=null? fmtInt(v.ppsm) : ""}</Td>
                          <Td>{v.baseUSD!=null? fmtInt(v.baseUSD) : ""}</Td>
                          <Td><StatusPill value={v.status||"available"} /></Td>
                          <Td>
                            <div className="w-[180px] flex gap-2">
                              <a className="btn" href={`#/calc?villaId=${encodeURIComponent(v.villaId)}`}>Рассчитать</a>
                              <button className="btn" onClick={()=>openEditVilla(project.projectId, v)}>Править</button>
                              <button className="btn" onClick={()=>deleteVilla(project.projectId, v.villaId)}>Удалить</button>
                            </div>
                          </Td>
                        </tr>
                      ))}
                      {project.villas.length===0 && <tr><td className="px-3 py-3 text-neutral-500" colSpan={12}>Нет вилл</td></tr>}
                    </tbody>
                  </table>
                </div>
              </section>
            ))}

            <VillaModal
              open={villaModal.open}
              initial={villaModal.init}
              onClose={()=>setVillaModal({ open:false, projectId:null, init:null })}
              onSave={saveVilla}
            />
          </div>
        );
      }

      const leaseFactorF = (year, totalYears, alpha) => { try { if (totalYears<=0 || year<0) return 1; return Math.pow((totalYears - year)/totalYears, alpha); } catch { return 1; } };
      const ageFactorF   = (year, beta) => { try { if (year<0 || beta<0) return 1; return Math.exp(-beta * year); } catch { return 1; } };
      const brandFactorF = (year, cfg) => {
        try {
          const { brandPeak, brandRampYears, brandPlateauYears, brandDecayYears, brandTail } = cfg;
          if (year <= brandRampYears) return 1 + (brandPeak-1) * (year/brandRampYears);
          if (year <= brandRampYears + brandPlateauYears) return brandPeak;
          if (year <= brandRampYears + brandPlateauYears + brandDecayYears) {
            const d = (year - brandRampYears - brandPlateauYears) / brandDecayYears;
            return brandPeak - (brandPeak - brandTail) * d;
          }
          return brandTail;
        } catch { return 1; }
      };
      const calculateIRR = (cashFlows, maxIterations=100, tolerance=1e-4) => {
        try {
          if (cashFlows.length<2) return 0;
          let guess=0.1;
          for (let it=0; it<maxIterations; it++) {
            let npv=0, der=0;
            for (let i=0;i<cashFlows.length;i++){
              const df = Math.pow(1+guess, i);
              npv += cashFlows[i]/df;
              if (i>0) der -= i*cashFlows[i]/(df*(1+guess));
            }
            if (Math.abs(npv)<tolerance) return guess*100;
            if (Math.abs(der)<tolerance) break;
            guess = guess - npv/der;
            if (guess<-0.99 || guess>10) break;
          }
          return guess*100;
        } catch { return 0; }
      };

      function CalcView({ catalog, villaId }) {
        const selected = useMemo(()=>{
          for (const p of catalog) {
            const v = p.villas.find(x=>x.villaId===villaId);
            if (v) return { project:p, villa:v };
          }
          return null;
        },[catalog, villaId]);

        const [lang, setLang] = useState('ru');
        const [currency, setCurrency] = useState('USD');
        const [idrPerUsd, setIdrPerUsd] = useState(16300);
        const [eurPerUsd, setEurPerUsd] = useState(0.88);
        const fmtMoney = (n) => {
          if (currency==='USD') return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(Math.round(n||0));
          if (currency==='EUR') return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(Math.round((n||0)*eurPerUsd));
          if (currency==='IDR') return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(Math.round((n||0)*idrPerUsd));
          return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(Math.round(n||0));
        };

        const [handoverMonth, setHandoverMonth] = useState(12);
        const [months, setMonths] = useState(12);
        const [monthlyRatePct, setMonthlyRatePct] = useState(8.33);
        const [startMonth, setStartMonth] = useState(new Date());
        const [pricingConfig, setPricingConfig] = useState({ inflationRatePct:10, leaseAlpha:1, agingBeta:0.025, brandPeak:1.2, brandRampYears:3, brandPlateauYears:4, brandDecayYears:8, brandTail:1.0 });

        const [isEditor, setIsEditor] = useState(false); // ТОЛЬКО для показа редакторских полей

        const [stages, setStages] = useState([
          {id:1,label:'Договор',pct:30,month:0},
          {id:2,label:'50% готовности',pct:30,month:6},
          {id:3,label:'70% готовности',pct:20,month:9},
          {id:4,label:'90% готовности',pct:15,month:11},
          {id:5,label:'Ключи',pct:5,month:12},
        ]);
        const stagesSumPct = stages.reduce((s,x)=> s+(+x.pct||0), 0);
        const addStage = () => setStages(prev=>[...prev, { id:prev.length+1, label:'Новый этап', pct:0, month:0 }]);
        const updStage = (id, patch) => setStages(prev=>prev.map(s=> s.id===id ? {...s, ...(patch.pct!==undefined ? {pct: clamp(+patch.pct||0,0,100)}:patch)} : s));
        const delStage = (id) => setStages(prev=>prev.filter(s=>s.id!==id));

        const [lines, setLines] = useState([]);
        useEffect(()=>{
          if (!selected) return;
          if (lines.length>0) return;
          const { project, villa } = selected;
          setLines([{
            id:1, projectId: project.projectId, villaId: villa.villaId, qty:1, prePct:70, ownTerms:false,
            months:null, monthlyRatePct:null, firstPostUSD:0, discountPct:0,
            monthlyPriceGrowthPct: villa.monthlyPriceGrowthPct||2,
            dailyRateUSD: villa.dailyRateUSD||150, occupancyPct:75, rentalPriceIndexPct: villa.rentalPriceIndexPct||5,
            snapshot: { name: villa.name, area: villa.area, ppsm: villa.ppsm, baseUSD: villa.baseUSD, leaseholdEndDate: villa.leaseholdEndDate ? new Date(villa.leaseholdEndDate) : null }
          }]);
        },[selected, lines.length]);

        const updLine = (id, patch) => setLines(prev=>prev.map(l=> l.id===id ? {...l, ...patch} : l));
        const delLine = (id) => setLines(prev=>prev.filter(l=> l.id!==id));

        const linesData = useMemo(()=>{
          return lines.map(line=>{
            const base0 = line.snapshot?.baseUSD ?? ((line.snapshot?.area||0)*(line.snapshot?.ppsm||0));
            const disc = clamp(+line.discountPct||0,0,20);
            const base = base0 * (1 - disc/100);
            const prePct = clamp(line.prePct ?? 0, 50, 100);

            const vMonths = line.ownTerms && line.months ? line.months : months;
            const rate = (line.ownTerms && line.monthlyRatePct!=null) ? (line.monthlyRatePct/100) : (monthlyRatePct/100);
            const firstPostUSD = Math.max(0,+line.firstPostUSD||0);

            const k = stagesSumPct===0 ? 0 : prePct/stagesSumPct;
            const preSchedule = stages.map(s=>({
              month: Math.max(0, Math.min(handoverMonth, Math.round(+s.month||0))),
              label: s.label,
              amountUSD: base * (((+s.pct||0)*k)/100),
            })).filter(r=>r.amountUSD>0).sort((a,b)=>a.month-b.month);

            const preTotalOne = preSchedule.reduce((s,r)=>s+r.amountUSD,0);

            let bal = Math.max(0, base - preTotalOne - firstPostUSD);
            let totalInterest = 0;
            const principalShare = vMonths>0 ? bal/vMonths : 0;
            const postRows = [];
            for (let i=1;i<=vMonths;i++){
              const interest = bal*rate; totalInterest += interest;
              const payment = principalShare + interest;
              postRows.push({ month: handoverMonth+i, label:`${i}`, principalUSD:principalShare, interestUSD:interest, paymentUSD:payment, balanceAfterUSD: Math.max(0, bal-principalShare) });
              bal -= principalShare;
            }

            const lineTotalOne = base + totalInterest;

            const qty = Math.max(1, parseInt(line.qty||1,10));
            const preScheduleQ = preSchedule.map(r=>({...r, amountUSD:r.amountUSD*qty}));
            const postRowsQ = postRows.map(r=>({...r, principalUSD:r.principalUSD*qty, interestUSD:r.interestUSD*qty, paymentUSD:r.paymentUSD*qty}));
            const preTotal = preTotalOne*qty;
            const baseQ = base*qty;
            const lineTotal = lineTotalOne*qty;

            return { line, qty, baseOne:base, base:baseQ, preSchedule:preScheduleQ, preTotal, firstPostUSD:firstPostUSD*qty, postRows:postRowsQ, lineTotal, vMonths, rate, discountPct:disc, prePct };
          });
        },[lines, stages, stagesSumPct, handoverMonth, months, monthlyRatePct]);

        const totals = useMemo(()=>{
          const baseUSD  = linesData.reduce((s,x)=> s+x.base, 0);
          const preUSD   = linesData.reduce((s,x)=> s+x.preTotal, 0);
          const finalUSD = linesData.reduce((s,x)=> s+x.lineTotal,0);
          const interestUSD = finalUSD - baseUSD;
          const afterUSD = finalUSD - preUSD;
          return { baseUSD, preUSD, finalUSD, interestUSD, afterUSD };
        },[linesData]);

        const formatMonth = (monthOffset) => {
          const date = new Date(startMonth); date.setMonth(date.getMonth()+monthOffset);
          return date.toLocaleDateString('ru-RU', { month:'long', year:'numeric' });
        };
        const getDaysInMonth = (monthOffset) => {
          const date = new Date(startMonth);
          date.setMonth(date.getMonth() + monthOffset);
          return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        };

        const getCleanLeaseholdTerm = (leaseholdEndDate) => {
          if (!leaseholdEndDate) return { years: 0, months: 0 };
          const handoverDate = new Date(startMonth);
          handoverDate.setMonth(handoverDate.getMonth() + handoverMonth);
          const diffTime = leaseholdEndDate.getTime() - handoverDate.getTime();
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          if (diffDays <= 0) return { years: 0, months: 0 };
          const years = Math.floor(diffDays / 365);
          const months = Math.floor((diffDays % 365) / 30);
          return { years, months };
        };

        const calculateMarketPriceAtHandover = (villa, line) => {
          if (!villa) return 0;
          const basePrice = villa.baseUSD || ((villa.area || 0) * (villa.ppsm || 0));
          const monthlyGrowthRate = ((line?.monthlyPriceGrowthPct ?? villa.monthlyPriceGrowthPct ?? 2) / 100);
          return basePrice * Math.pow(1 + monthlyGrowthRate, handoverMonth);
        };

        const getIndexedRentalPrice = (baseDailyUSD, indexPct, yearOffset) => {
          if (yearOffset <= 0) return baseDailyUSD || 0;
          return (baseDailyUSD || 0) * Math.pow(1 + (indexPct || 0) / 100, yearOffset);
        };

        const generatePricingData = (villa, line) => {
          if (!villa?.leaseholdEndDate) return [];
          const leaseEnd = new Date(villa.leaseholdEndDate);
          const totalYears = Math.max(0, Math.ceil((leaseEnd - startMonth) / (365 * 24 * 60 * 60 * 1000)));
          const data = [];
          const baseAtHandover = calculateMarketPriceAtHandover(villa, line);
          for (let year = 0; year <= totalYears; year++) {
            const inflation = Math.pow(1 + 10/100, year);
            const lf = leaseFactorF(year, totalYears, 1);
            const af = ageFactorF(year, 0.025);
            const bf = brandFactorF(year, { brandPeak:1.2, brandRampYears:3, brandPlateauYears:4, brandDecayYears:8, brandTail:1.0 });
            const finalPrice = baseAtHandover * inflation * lf * af * bf;
            data.push({ year, finalPrice, leaseFactor:lf, ageFactor:af, brandFactor:bf, inflation });
          }
          return data;
        };

        const firstLine = lines[0];
        const selectedVilla = useMemo(()=>{
          if (!firstLine) return null;
          for (const p of catalog) {
            const v = p.villas.find(x=>x.villaId===firstLine.villaId);
            if (v) return v;
          }
          return null;
        }, [catalog, lines]);

        const leaseTerm = useMemo(()=>{
          return selectedVilla?.leaseholdEndDate ? getCleanLeaseholdTerm(new Date(selectedVilla.leaseholdEndDate)) : { years: 0, months: 0 };
        }, [selectedVilla, startMonth, handoverMonth]);

        const monthBeforeKeys = Math.max(0, handoverMonth - 1);
        const basePrice0 = selectedVilla ? (selectedVilla.baseUSD || ((selectedVilla.area||0)*(selectedVilla.ppsm||0))) : 0;
        const monthlyGrowthRate = ((firstLine?.monthlyPriceGrowthPct ?? selectedVilla?.monthlyPriceGrowthPct ?? 2) / 100);
        const priceBeforeKeys = basePrice0 * Math.pow(1 + monthlyGrowthRate, monthBeforeKeys);
        const roiBeforeKeysAnnual = totals.finalUSD > 0 ? (((priceBeforeKeys - totals.finalUSD) / totals.finalUSD) * (12 / Math.max(1, monthBeforeKeys + 1)) * 100) : 0;
        const netIncomeBeforeKeys = priceBeforeKeys - totals.finalUSD;

        const calculateOptimalExit = (villa, line, contractFinalUSD) => {
          const pricing = generatePricingData(villa, line);
          if (pricing.length === 0) return { year: 0, irr: 0, totalValue: 0 };
          let best = { year: 0, irr: -Infinity, totalValue: 0 };
          for (let i = 1; i < pricing.length; i++) {
            const cashFlows = [-contractFinalUSD];
            for (let y = 0; y < i; y++) cashFlows.push(0);
            cashFlows.push(pricing[i].finalPrice);
            const irr = calculateIRR(cashFlows);
            if (irr > best.irr) best = { year: pricing[i].year, irr, totalValue: pricing[i].finalPrice };
          }
          return best;
        };

        const optimalExit = useMemo(()=>{
          if (!selectedVilla || !firstLine) return { year: 0, irr: 0, totalValue: 0 };
          return calculateOptimalExit(selectedVilla, firstLine, totals.finalUSD);
        }, [selectedVilla, firstLine, totals.finalUSD, handoverMonth, startMonth]);

        const exitYearAbs = Math.floor(startMonth.getFullYear() + handoverMonth / 12 + optimalExit.year);
        const finalCumulativeROI = totals.finalUSD > 0 ? (((optimalExit.totalValue - totals.finalUSD) / totals.finalUSD) * 100) : 0;

        // ——— Настройки + Стадии
        const settingsStages = (
          <div className="grid md:grid-cols-2 gap-4 mt-4">
            <div className="card">
              <div className="card-header"><h3>Рассрочка до получения ключей</h3></div>
              <div className="overflow-x-auto">
                <table className="stages-table">
                  <thead><tr><Th>Этап</Th><Th>%</Th><Th>Месяц</Th><Th>Удалить</Th></tr></thead>
                  <tbody>
                    {stages.map(s=>(
                      <tr key={s.id}>
                        <Td><input className="px-2 py-1 rounded border w-full" value={s.label} onChange={(e)=>updStage(s.id,{label:e.target.value})}/></Td>
                        <Td><input className="px-2 py-1 rounded border w-24" type="number" value={s.pct} onChange={(e)=>updStage(s.id,{pct:e.target.value})}/></Td>
                        <Td><input className="px-2 py-1 rounded border w-24" type="number" value={s.month} onChange={(e)=>updStage(s.id,{month:+e.target.value})}/></Td>
                        <Td><button className="btn" onClick={()=>delStage(s.id)}>Удалить</button></Td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="flex items-center gap-3 mt-3">
                <button className="btn" onClick={addStage}>Добавить этап</button>
                <div className="pill">Σ: {stagesSumPct.toFixed(2)}%</div>
              </div>
            </div>

            <div className="card settings-card">
              <div className="card-header"><h3>Настройки</h3></div>
              <div className="row">
                <div className="field compact">
                  <label>Язык интерфейса</label>
                  <select value={lang} onChange={(e)=>setLang(e.target.value)}>
                    <option value="ru">Русский</option><option value="en">English</option>
                  </select>
                </div>
                <div className="field compact">
                  <label>Валюта отображения</label>
                  <select value={currency} onChange={(e)=>setCurrency(e.target.value)}>
                    <option>USD</option><option>EUR</option><option>IDR</option>
                  </select>
                </div>
                <div className="field compact">
                  <label>Режим</label>
                  <select value={isEditor ? 'editor' : 'client'} onChange={(e)=>setIsEditor(e.target.value==='editor')}>
                    <option value="client">Клиент</option>
                    <option value="editor">Редактор</option>
                  </select>
                </div>
              </div>

              <div className="row">
                <div className="field compact">
                  <label>Заключение договора</label>
                  <div className="pill">{startMonth.toLocaleDateString('ru-RU',{month:'long',year:'numeric'})}</div>
                </div>
                <div className="field compact">
                  <label>Срок строительства (мес)</label>
                  <input type="number" min="1" step="1" value={handoverMonth} onChange={(e)=>setHandoverMonth(clamp(parseInt(e.target.value||0,10),1,120))}/>
                </div>
                <div className="field compact">
                  <label>Post‑handover рассрочка (мес)</label>
                  <input type="number" min="6" step="1" value={months} onChange={(e)=>setMonths(clamp(parseInt(e.target.value||0,10),6,120))}/>
                </div>
              </div>

              {isEditor && (
                <div className="row">
                  <div className="field compact">
                    <label>Глобальная ставка, %/мес</label>
                    <input type="number" min="0" step="0.01" value={monthlyRatePct} onChange={(e)=>setMonthlyRatePct(clamp(parseFloat(e.target.value||0),0,1000))}/>
                  </div>
                </div>
              )}

              <div className="row">
                <div className="field compact">
                  <label>IDR за 1 USD</label>
                  <input type="number" min="1" step="1" value={idrPerUsd} onChange={(e)=>setIdrPerUsd(clamp(parseFloat(e.target.value||0),1,1e9))}/>
                </div>
                <div className="field compact">
                  <label>EUR за 1 USD</label>
                  <input type="number" min="0.01" step="0.01" value={eurPerUsd} onChange={(e)=>setEurPerUsd(clamp(parseFloat(e.target.value||0),0.01,100))}/>
                </div>
              </div>
            </div>
          </div>
        );

        // ——— Объект недвижимости
        const positions = (
          <div className="card">
            <div className="card-header"><h3>Объект недвижимости</h3></div>
            <div className="calc-scroll">
              <table className="calc-table min-w-[980px] w-full">
                <thead>
                  <tr>
                    <Th>Проект</Th><Th>Вилла</Th><Th>Кол-во</Th><Th>м²</Th><Th>$ / м²</Th><Th>Текущая стоимость (USD)</Th>
                    <Th>Скидка, %</Th><Th>До ключей, %</Th><Th>Месяцы</Th><Th>Ставка, %/мес</Th><Th>Итоговая стоимость</Th><Th>—</Th>
                  </tr>
                </thead>
                <tbody>
                  {linesData.map(ld=>(
                    <tr key={ld.line.id}>
                      <Td style={{textAlign:'left'}}>{selected?.project.projectName}</Td>
                      <Td style={{textAlign:'left'}}>{ld.line.snapshot?.name}</Td>
                      <Td><input className="px-2 py-1 rounded border w-20" type="number" min="1" step="1" value={ld.line.qty} onChange={(e)=>updLine(ld.line.id,{qty: clamp(parseInt(e.target.value||0,10),1,9999)})}/></Td>
                      <Td>{fmtInt(ld.line.snapshot?.area||0)}</Td>
                      <Td>{fmtInt(ld.line.snapshot?.ppsm||0)}</Td>
                      <Td className="amount">{fmtMoney(ld.base)}</Td>
                      <Td><input className="px-2 py-1 rounded border w-20" type="number" min="0" max="20" step="0.1" value={ld.line.discountPct||0} onChange={(e)=>updLine(ld.line.id,{discountPct:clamp(parseFloat(e.target.value||0),0,20)})}/></Td>
                      <Td>
                        <input type="range" min="50" max="100" step="1" value={Math.max(50,Math.min(100, ld.prePct||0))} onChange={(e)=>updLine(ld.line.id,{prePct: parseInt(e.target.value,10)})}/>
                        <div className="muted">{Math.max(50,Math.min(100, ld.prePct||0))}%</div>
                      </Td>
                      <Td><input className="px-2 py-1 rounded border w-20" type="number" min="6" step="1" value={ld.vMonths} onChange={(e)=>updLine(ld.line.id,{ownTerms:true, months: clamp(parseInt(e.target.value||0,10),6,120)})}/></Td>
                      <Td><input className="px-2 py-1 rounded border w-24" type="number" min="0" step="0.01" value={ld.line.monthlyRatePct??monthlyRatePct} onChange={(e)=>updLine(ld.line.id,{ownTerms:true, monthlyRatePct: clamp(parseFloat(e.target.value||0),0,1000)})}/></Td>
                      <Td className="amount">{fmtMoney(ld.lineTotal)}</Td>
                      <Td><button className="btn" onClick={()=>delLine(ld.line.id)}>Удалить</button></Td>
                    </tr>
                  ))}
                  {linesData.length===0 && <tr><td colSpan={12} className="px-3 py-3 text-neutral-500">Нет выбранных вилл</td></tr>}
                </tbody>
              </table>
            </div>
          </div>
        );

        // ——— KPI
        const kpi = (
          <div className="card">
            <div className="kpis">
              <div className="kpi"><div className="muted">Selected villas</div><div className="v">{lines.length}</div></div>
              <div className="kpi"><div className="muted">Keys in</div><div className="v">{handoverMonth} mo.</div></div>
              <div className="kpi"><div className="muted">Срок рассрочки после получения ключей</div><div className="v">{months} mo.</div></div>
              <div className="kpi"><div className="muted">Client</div><div className="v">—</div></div>
              <div className="kpi"><div className="muted">Payment before keys</div><div className="v">{fmtMoney(totals.preUSD)}</div></div>
              <div className="kpi"><div className="muted">Payment after keys</div><div className="v">{fmtMoney(totals.afterUSD)}</div></div>
              <div className="kpi"><div className="muted">Final value</div><div className="v">{fmtMoney(totals.finalUSD)}</div></div>
              <div className="kpi"><div className="muted">ROI when selling before keys</div><div className="v">{roiBeforeKeysAnnual.toFixed(1)}%</div></div>
              <div className="kpi"><div className="muted">Net income</div><div className="v">{fmtMoney(netIncomeBeforeKeys)}</div></div>
              <div className="kpi"><div className="muted">Clean leasehold term</div><div className="v">{leaseTerm.years} years {leaseTerm.months} months</div></div>
              <div className="kpi"><div className="muted">Exit point with max IRR</div><div className="v">{exitYearAbs}</div></div>
              <div className="kpi"><div className="muted">IRR</div><div className="v">{optimalExit.irr.toFixed(1)}%</div></div>
              <div className="kpi"><div className="muted">Final cumulative ROI</div><div className="v">{finalCumulativeROI.toFixed(1)}%</div></div>
            </div>
          </div>
        );

        // ——— График (как раньше)
        const pricing = selectedVilla ? generatePricingData(selectedVilla, firstLine) : [];
        const chart = selectedVilla && pricing.length>0 && (() => {
          const occ = (firstLine?.occupancyPct ?? 75) / 100;
          const baseDaily = firstLine?.dailyRateUSD ?? selectedVilla?.dailyRateUSD ?? 0;
          const indexPct = firstLine?.rentalPriceIndexPct ?? selectedVilla?.rentalPriceIndexPct ?? 0;
          const rentalData = pricing.map((d) => {
            const daily = getIndexedRentalPrice(baseDaily, indexPct, d.year);
            const workingMonths = d.year===0 ? (handoverMonth>=12 ? 0 : Math.max(0, 12 - Math.max(0, handoverMonth + 3))) : 12;
            return { year: d.year, rentalIncome: daily * 0.55 * occ * 30.44 * workingMonths };
          });
          const maxPrice = Math.max(...pricing.map(d=>d.finalPrice));
          const maxRental = Math.max(...rentalData.map(d=>d.rentalIncome));
          const globalMax = Math.max(maxPrice, maxRental);
          const globalMin = 0;
          const scaleY = (val) => 250 - ((val - globalMin) / Math.max(1, (globalMax - globalMin))) * 200;

          return (
            <div className="card">
              <div className="card-header"><h3>Villa cost and rental income dynamics</h3></div>
              <div className="pricing-chart-svg">
                <svg width="100%" height="300" viewBox="0 0 800 300">
                  <line x1="50" y1="50" x2="50" y2="250" stroke="#666" strokeWidth="1" />
                  <line x1="50" y1="250" x2="750" y2="250" stroke="#666" strokeWidth="1" />

                  <polyline fill="none" stroke="#3b82f6" strokeWidth="2" points={pricing.map((d,i)=>`${50 + i*35},${scaleY(d.finalPrice)}`).join(" ")} />
                  {pricing.map((d,i)=><circle key={`p-${i}`} cx={50 + i*35} cy={scaleY(d.finalPrice)} r="3" fill="#3b82f6" />)}

                  <polyline fill="none" stroke="#10b981" strokeWidth="2" points={rentalData.map((d,i)=>`${50 + i*35},${scaleY(d.rentalIncome)}`).join(" ")} />
                  {rentalData.map((d,i)=><circle key={`r-${i}`} cx={50 + i*35} cy={scaleY(d.rentalIncome)} r="3" fill="#10b981" />)}

                  {[0,0.25,0.5,0.75,1].map((r,i)=>{
                    const val = globalMin + r*(globalMax-globalMin);
                    const y = 250 - r*200;
                    return (
                      <g key={i}>
                        <line x1="45" y1={y} x2="50" y2={y} stroke="#666" strokeWidth="1" />
                        <text x="40" y={y+4} fontSize="10" textAnchor="end" fill="#666">{fmtMoney(val)}</text>
                      </g>
                    );
                  })}

                  {pricing.map((d,i)=>{
                    const realYear = Math.floor(startMonth.getFullYear() + handoverMonth/12 + d.year);
                    return <text key={`x-${i}`} x={50 + i*35} y="270" fontSize="12" textAnchor="middle" fill="#666">{realYear}</text>;
                  })}

                  <rect x="600" y="20" width="15" height="15" fill="#3b82f6" />
                  <text x="620" y="32" fontSize="12" fill="#333">Market value</text>
                  <rect x="600" y="40" width="15" height="15" fill="#10b981" />
                  <text x="620" y="52" fontSize="12" fill="#333">Rental income</text>
                </svg>
              </div>
            </div>
          );
        })();

        // ——— Годовая таблица
        const annualRows = useMemo(()=>{
          if (!selectedVilla || !firstLine) return [];
          const pricing = generatePricingData(selectedVilla, firstLine);
          if (pricing.length === 0) return [];
          const occ = (firstLine?.occupancyPct ?? 75) / 100;
          const baseDaily = firstLine?.dailyRateUSD ?? selectedVilla?.dailyRateUSD ?? 0;
          const indexPct = firstLine?.rentalPriceIndexPct ?? selectedVilla?.rentalPriceIndexPct ?? 0;
          const avgDays = 30.44;

          return pricing.map((d, idx)=>{
            let workingMonths = idx===0 ? (handoverMonth>=12 ? 0 : Math.max(0, 12 - Math.max(0, handoverMonth + 3))) : 12;
            const daily = getIndexedRentalPrice(baseDaily, indexPct, d.year);
            const rentalIncome = daily * 0.55 * occ * avgDays * workingMonths * (firstLine?.qty || 1);
            const totalCapitalization = d.finalPrice + rentalIncome;
            const prev = idx>0 ? pricing[idx-1] : null;
            const priceChange = prev ? (d.finalPrice - prev.finalPrice) : 0;
            const yearlyRoi = prev ? ((rentalIncome + priceChange) / Math.max(1, prev.finalPrice)) * 100 : 0;
            let cumRent = 0;
            for (let y=0;y<=idx;y++){
              const wd = (y===0) ? (handoverMonth>=12 ? 0 : Math.max(0, 12 - Math.max(0, handoverMonth + 3))) : 12;
              const dly = getIndexedRentalPrice(baseDaily, indexPct, y);
              cumRent += dly * 0.55 * occ * avgDays * wd * (firstLine?.qty || 1);
            }
            const cumulativeRoi = totals.finalUSD>0 ? ((cumRent + d.finalPrice - totals.finalUSD) / totals.finalUSD) * 100 : 0;
            const cashFlows = [-totals.finalUSD];
            for (let y=0;y<=idx;y++){
              const wd = (y===0) ? (handoverMonth>=12 ? 0 : Math.max(0, 12 - Math.max(0, handoverMonth + 3))) : 12;
              const dly = getIndexedRentalPrice(baseDaily, indexPct, y);
              const rent = dly * 0.55 * occ * avgDays * wd * (firstLine?.qty || 1);
              if (y===idx) cashFlows.push(rent + d.finalPrice); else cashFlows.push(rent);
            }
            const irr = calculateIRR(cashFlows);
            return { displayYear: Math.floor(startMonth.getFullYear() + handoverMonth/12 + d.year), ...d, rentalIncome, totalCapitalization, yearlyRoi, cumulativeRoi, irr };
          });
        },[selectedVilla, firstLine, handoverMonth, startMonth, totals.finalUSD]);

        const annualTable = (
          <div className="card">
            <div className="card-header"><h3>Calculation of indicators (annual)</h3></div>
            <div className="factors-table-container">
              <div className="factors-table-scroll">
                <table className="factors-table min-w-[1200px]">
                  <thead>
                    <tr>
                      <Th>Year</Th><Th>Lease Factor</Th><Th>Age Factor</Th><Th>Brand Factor</Th><Th>Inflation</Th><Th>Market value</Th>
                      <Th>Rental income</Th><Th>Total capitalization</Th><Th>Yearly ROI (%)</Th><Th>Cumulative ROI (%)</Th><Th>IRR (%)</Th>
                    </tr>
                  </thead>
                  <tbody>
                    {annualRows.length>0 ? annualRows.map((r,i)=>(
                      <tr key={i}>
                        <Td>{r.displayYear}</Td>
                        <Td>{r.leaseFactor.toFixed(3)}</Td>
                        <Td>{r.ageFactor.toFixed(3)}</Td>
                        <Td>{r.brandFactor.toFixed(3)}</Td>
                        <Td>{r.inflation.toFixed(3)}</Td>
                        <Td className="price-cell">{fmtMoney(r.finalPrice)}</Td>
                        <Td className="price-cell">{fmtMoney(r.rentalIncome)}</Td>
                        <Td className="total-capital-cell">{fmtMoney(r.totalCapitalization)}</Td>
                        <Td className="yearly-roi-cell">{r.yearlyRoi.toFixed(2)}%</Td>
                        <Td className="cumulative-roi-cell">{r.cumulativeRoi.toFixed(2)}%</Td>
                        <Td className="irr-cell">{r.irr.toFixed(2)}%</Td>
                      </tr>
                    )) : <tr><td colSpan={11} className="px-3 py-3 text-neutral-500">Нет данных</td></tr>}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        );

        const baseAtHandover = selectedVilla ? calculateMarketPriceAtHandover(selectedVilla, firstLine) : 0;
        const monthlyRows = useMemo(()=>{
          if (!selectedVilla || !firstLine) return [];
          const totalMonths = handoverMonth + (linesData[0]?.vMonths || months);
          const occ = (firstLine?.occupancyPct ?? 75) / 100;
          const baseDaily = firstLine?.dailyRateUSD ?? selectedVilla?.dailyRateUSD ?? 0;
          const indexPct = firstLine?.rentalPriceIndexPct ?? selectedVilla?.rentalPriceIndexPct ?? 0;

          const preMap = new Map(); const postMap = new Map();
          linesData.forEach(ld=>{
            ld.preSchedule.forEach(r=> preMap.set(r.month, (preMap.get(r.month)||0) + r.amountUSD));
            ld.postRows.forEach(r=> postMap.set(r.month, (postMap.get(r.month)||0) + r.paymentUSD));
          });

          const result = [];
          let totalPaymentsToDate = 0;
          for (let m = 0; m <= totalMonths; m++) {
            let inflationFactor = 1, lf=1, af=1, bf=1, finalPrice = 0;
            if (m <= handoverMonth) {
              const base = (selectedVilla.baseUSD || ((selectedVilla.area||0)*(selectedVilla.ppsm||0)));
              finalPrice = base * Math.pow(1 + ((firstLine?.monthlyPriceGrowthPct ?? selectedVilla?.monthlyPriceGrowthPct ?? 2)/100), m);
            } else {
              const yearOffset = (m - handoverMonth) / 12;
              inflationFactor = Math.pow(1 + 10/100, yearOffset);
              lf = leaseFactorF(yearOffset, 30, 1);
              af = ageFactorF(yearOffset, 0.025);
              bf = brandFactorF(yearOffset, { brandPeak:1.2, brandRampYears:3, brandPlateauYears:4, brandDecayYears:8, brandTail:1.0 });
              finalPrice = baseAtHandover * inflationFactor * lf * af * bf;
            }

            const paymentAmount = (preMap.get(m)||0) + (postMap.get(m)||0);
            totalPaymentsToDate += paymentAmount;

            let rentalIncome = 0;
            if (m >= handoverMonth + 3) {
              const yearOffset = (m - handoverMonth) / 12;
              const daily = getIndexedRentalPrice(baseDaily, indexPct, Math.floor(yearOffset));
              rentalIncome = daily * 0.55 * occ * getDaysInMonth(m) * (firstLine?.qty || 1);
            }

            const prev = result[result.length-1];
            const priceChange = prev ? (finalPrice - prev.finalPrice) : 0;
            const monthlyRoi = totalPaymentsToDate>0 ? ((rentalIncome + priceChange) / totalPaymentsToDate) * 100 : 0;
            const cumulativeRoi = totals.finalUSD>0 ? ((finalPrice - totals.finalUSD) / totals.finalUSD) * 100 : 0;

            const cashFlows = [-totals.finalUSD];
            for (let j=0;j<=m;j++){
              const rj = (j >= handoverMonth + 3)
                ? (getIndexedRentalPrice(baseDaily, indexPct, Math.floor((j - handoverMonth)/12)) * 0.55 * occ * getDaysInMonth(j) * (firstLine?.qty || 1))
                : 0;
              if (j===m) cashFlows.push(rj + finalPrice); else cashFlows.push(rj);
            }
            const irr = calculateIRR(cashFlows);

            result.push({
              month: m, monthLabel: formatMonth(m),
              leaseFactor: lf, ageFactor: af, brandFactor: bf, inflationFactor,
              finalPrice, rentalIncome, totalInvestorCapital: finalPrice + rentalIncome,
              paymentAmount, totalPaymentsToDate, monthlyRoi, cumulativeRoi, irr
            });
          }
          return result;
        },[selectedVilla, firstLine, handoverMonth, months, linesData, totals.finalUSD]);

        const monthlyTable = (
          <div className="card">
            <div className="card-header"><h3>Calculation of indicators (for installment period)</h3></div>
            <div className="factors-table-container">
              <div className="factors-table-scroll">
                <table className="factors-table min-w-[1400px]">
                  <thead>
                    <tr>
                      <Th>Period</Th><Th>Lease Factor</Th><Th>Age Factor</Th><Th>Brand Factor</Th><Th>Inflation</Th>
                      <Th>Market value</Th><Th>Rental income</Th><Th>Total capitalization</Th><Th>Installment payment</Th>
                      <Th>Monthly ROI (%)</Th><Th>Cumulative ROI (%)</Th><Th>IRR (%)</Th>
                    </tr>
                  </thead>
                  <tbody>
                    {monthlyRows.length>0 ? monthlyRows.map((r)=>(
                      <tr key={r.month}>
                        <Td>{r.monthLabel}</Td>
                        <Td>{(r.leaseFactor||1).toFixed(3)}</Td>
                        <Td>{(r.ageFactor||1).toFixed(3)}</Td>
                        <Td>{(r.brandFactor||1).toFixed(3)}</Td>
                        <Td>{(r.inflationFactor||1).toFixed(3)}</Td>
                        <Td className="price-cell">{fmtMoney(r.finalPrice)}</Td>
                        <Td className="price-cell">{fmtMoney(r.rentalIncome)}</Td>
                        <Td className="total-capital-cell">{fmtMoney(r.totalInvestorCapital)}</Td>
                        <Td className="payment-cell">{r.paymentAmount>0 ? fmtMoney(r.paymentAmount) : '-'}</Td>
                        <Td className="monthly-roi-cell">{r.monthlyRoi.toFixed(2)}%</Td>
                        <Td className="cumulative-roi-cell">{r.cumulativeRoi.toFixed(2)}%</Td>
                        <Td className="irr-cell">{r.irr.toFixed(2)}%</Td>
                      </tr>
                    )) : <tr><td colSpan={12} className="px-3 py-3 text-neutral-500">Нет данных</td></tr>}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        );

        // ——— Полный график платежей (все столбцы)
        const fullCashflow = (()=> {
          const m = new Map();
          const push=(month, amt, desc)=>{ if (amt<=0) return; const prev=m.get(month)||{month,items:[],amountUSD:0}; prev.items.push(desc); prev.amountUSD+=amt; m.set(month,prev); };
          linesData.forEach(ld=>{
            ld.preSchedule.forEach(r=> push(r.month, r.amountUSD, `${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: ${r.label}`));
            if (ld.firstPostUSD>0) push(handoverMonth+1, ld.firstPostUSD, `${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: Первый платёж`);
            ld.postRows.forEach(r=> push(r.month, r.paymentUSD, `${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: Месяц ${r.label}`));
          });

          const rentalMap = new Map();
          lines.forEach(ln=>{
            const occ = (ln.occupancyPct ?? 75)/100;
            const baseDaily = ln.dailyRateUSD ?? 0;
            const idxPct = ln.rentalPriceIndexPct ?? 0;
            for (let mon = handoverMonth+3; mon <= handoverMonth + (linesData[0]?.vMonths || months); mon++){
              const yOff = Math.floor((mon - handoverMonth)/12);
              const daily = getIndexedRentalPrice(baseDaily, idxPct, yOff);
              const val = daily * 0.55 * occ * getDaysInMonth(mon) * (ln.qty || 1);
              rentalMap.set(mon, (rentalMap.get(mon)||0) + val);
            }
          });

          const rows = [...m.values()].sort((a,b)=>a.month-b.month);
          let acc=0;
          return (
            <div className="card">
              <div className="card-header"><h3>Полный график платежей</h3></div>
              <div className="cashflow-table-container">
                <table className="cashflow-table min-w-[1200px]">
                  <thead>
                    <tr>
                      <Th>Месяц</Th><Th>Описание</Th><Th>Платеж</Th><Th>Арендный доход</Th><Th>Чистый платеж/доход в месяц</Th><Th>Остаток по договору</Th>
                    </tr>
                  </thead>
                  <tbody>
                    {rows.length>0 ? rows.map(row=>{
                      acc += row.amountUSD;
                      const balance = Math.max(0, totals.finalUSD - acc);
                      const rent = rentalMap.get(row.month)||0;
                      const net = row.amountUSD - rent;
                      return (
                        <tr key={row.month}>
                          <Td>{formatMonth(row.month)}</Td>
                          <Td>{row.items.join(' + ')}</Td>
                          <Td>{fmtMoney(row.amountUSD)}</Td>
                          <Td>{fmtMoney(rent)}</Td>
                          <Td className={net>=0 ? 'negative' : 'positive'}>{fmtMoney(net)}</Td>
                          <Td>{fmtMoney(balance)}</Td>
                        </tr>
                      );
                    }) : <tr><td colSpan={6} className="px-3 py-3 text-neutral-500">Нет платежей</td></tr>}
                  </tbody>
                </table>
              </div>
            </div>
          );
        })();

        return (
          <div className="grid">
            {/* Левая/правая колонки по мотивам вашего CSS сетки */}
            <div className="col-span-2">
              {settingsStages}
              {positions}
              {kpi}
              {chart}
              {annualTable}
              {monthlyTable}
              {fullCashflow}
            </div>
          </div>
        );
      }

      function Kpi({ label, value }) {
        return (
          <div className="kpi">
            <div className="muted">{label}</div>
            <div className="v">{value}</div>
          </div>
        );
      }

      function CatalogView({ catalog }) {
        return (
          <div className="grid">
            <div className="col-span-2">
              <div className="card">
                <div className="card-header"><h3>Каталог проектов</h3><a href="#/admin" className="btn">Админ</a></div>
                <div className="grid gap-8">
                  {catalog.map(project=>(
                    <section key={project.projectId} className="card">
                      <div className="card-header"><h3>{project.projectName}</h3></div>
                      {project.includes?.length>0 && <ul className="text-sm text-neutral-700 mb-3">{project.includes.map((x,i)=><li key={i}>• {x}</li>)}</ul>}
                      <div className="overflow-x-auto">
                        <table className="w-full text-[clamp(11px,0.9vw,14px)] min-w-[1200px]">
                          <thead>
                            <tr className="bg-neutral-50">
                              <Th>Вилла</Th><Th>Q Rooms</Th><Th>Земля, м²</Th><Th>Вилла, м²</Th><Th>1 этаж, м²</Th><Th>2 этаж, м²</Th><Th>Руфтоп, м²</Th><Th>Сад+бассейн, м²</Th>
                              <Th>$ / м²</Th><Th>База, $</Th><Th><span className="inline-block w-[140px]">Статус</span></Th><Th><span className="inline-block w-[140px]">Действия</span></Th>
                            </tr>
                          </thead>
                          <tbody>
                            {project.villas.map(v=>(
                              <tr key={v.villaId} className="border-t">
                                <Td className="whitespace-nowrap">{v.name}</Td>
                                <Td>{v.rooms||""}</Td>
                                <Td>{v.land!=null? fmt2(v.land) : ""}</Td>
                                <Td>{v.area!=null? fmt2(v.area) : ""}</Td>
                                <Td>{v.f1!=null? fmt2(v.f1) : ""}</Td>
                                <Td>{v.f2!=null? fmt2(v.f2) : ""}</Td>
                                <Td>{v.roof!=null? fmt2(v.roof) : ""}</Td>
                                <Td>{v.garden!=null? fmt2(v.garden) : ""}</Td>
                                <Td>{v.ppsm!=null? fmtInt(v.ppsm) : ""}</Td>
                                <Td>{v.baseUSD!=null? fmtInt(v.baseUSD) : ""}</Td>
                                <Td><div className="w-[140px] overflow-hidden"><StatusPill value={v.status||"available"} /></div></Td>
                                <Td><div className="w-[140px]"><a className="btn" href={`#/calc?villaId=${encodeURIComponent(v.villaId)}`}>Рассчитать</a></div></Td>
                              </tr>
                            ))}
                            {project.villas.length===0 && <tr><td className="px-3 py-3 text-neutral-500" colSpan={12}>Нет вилл</td></tr>}
                          </tbody>
                        </table>
                      </div>
                    </section>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      }

      function App() {
        const route = useHashRoute();
        const [catalog, setCatalog] = useState(loadCatalog());
        const [isAdmin, setIsAdmin] = useState(false);
        useEffect(()=>saveCatalog(catalog),[catalog]);
        return (
          <div className="min-h-screen">
            <Header />
            {route.path==="#/admin" ? (
              isAdmin ? <AdminPanel catalog={catalog} setCatalog={setCatalog} /> : <AdminGate onLogin={()=>setIsAdmin(true)} />
            ) : route.path==="#/calc" ? (
              <CalcView catalog={catalog} villaId={route.params.villaId} />
            ) : (
              <CatalogView catalog={catalog} />
            )}
          </div>
        );
      }

      const root = createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
