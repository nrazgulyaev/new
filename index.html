<!doctype html>
<html lang="ru">
  <head>
    <!-- продолжаем -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Arconique · Каталог / Админ / Калькулятор</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:," />
  </head>
  <body class="bg-white">
    <div id="root"></div>

    <!-- React 18 UMD + Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- (необязательно) для экспорта XLSX/PDF подключите по желанию:
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    -->

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;
      const { createRoot } = ReactDOM;

      // ==========================
      // Конфиг / Утилиты / Хранилище
      // ==========================
      const PIN_CODE = "334346";
      const LS_CATALOG = "arq_catalog_v1";

      const uid = () => Math.random().toString(36).slice(2, 9);
      const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
      const fmtInt = (n) => new Intl.NumberFormat("ru-RU", { maximumFractionDigits: 0 }).format(Math.round(n || 0));
      const fmtMoney = (n, c = "USD") =>
        new Intl.NumberFormat("en-US", { style: "currency", currency: c, maximumFractionDigits: 0 }).format(Math.round(n || 0));

      const loadCatalog = () => {
        try {
          const raw = localStorage.getItem(LS_CATALOG);
          if (!raw) return defaultCatalog();
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : defaultCatalog();
        } catch {
          return defaultCatalog();
        }
      };
      const saveCatalog = (catalog) => {
        try { localStorage.setItem(LS_CATALOG, JSON.stringify(catalog)); } catch {}
      };

      function defaultCatalog() {
        return [
          {
            projectId: "ahau-gardens",
            projectName: "Ahau Gardens by Arconique",
            villas: [
              {
                villaId: "ahau-type-a-2br",
                name: "Type A 2 bedroom",
                area: 142.7,
                ppsm: 2200,
                baseUSD: 313940,
                monthlyPriceGrowthPct: 2,
                leaseholdEndDate: "2055-01-01",
                dailyRateUSD: 220,
                rentalPriceIndexPct: 5
              },
              {
                villaId: "ahau-type-b-2br",
                name: "Type B 2 bedroom",
                area: 192,
                ppsm: 2250,
                baseUSD: 432000,
                monthlyPriceGrowthPct: 2,
                leaseholdEndDate: "2055-01-01",
                dailyRateUSD: 280,
                rentalPriceIndexPct: 5
              }
            ]
          },
          {
            projectId: "enso-villas",
            projectName: "ENSO by Arconique",
            villas: [
              {
                villaId: "enso-l-type-2br",
                name: "L type 2 bedroom",
                area: 104.1,
                ppsm: 2610,
                baseUSD: 271701,
                monthlyPriceGrowthPct: 2,
                leaseholdEndDate: "2054-12-01",
                dailyRateUSD: 220,
                rentalPriceIndexPct: 5
              },
              {
                villaId: "enso-v-type-2br",
                name: "V type 2 bedroom",
                area: 114.1,
                ppsm: 2548,
                baseUSD: 290840,
                monthlyPriceGrowthPct: 2,
                leaseholdEndDate: "2054-12-01",
                dailyRateUSD: 220,
                rentalPriceIndexPct: 5
              }
            ]
          },
          {
            projectId: "eternal-villas",
            projectName: "Eternal Villas by Arconique",
            villas: [
              {
                villaId: "eternal-premium-3br",
                name: "Premium 3 bedroom",
                area: 218,
                ppsm: 2197,
                baseUSD: 479000,
                monthlyPriceGrowthPct: 2,
                leaseholdEndDate: "2055-01-01",
                dailyRateUSD: 550,
                rentalPriceIndexPct: 5
              }
            ]
          }
        ];
      }

      // Простой hash-роутер
      function useHashRoute() {
        const parse = () => {
          const hash = window.location.hash || "#/catalog";
          const [path, q] = hash.split("?");
          const params = {};
          if (q) q.split("&").forEach(s => { const [k,v] = s.split("="); params[decodeURIComponent(k)] = decodeURIComponent(v||""); });
          return { path, params };
        };
        const [route, setRoute] = useState(parse());
        useEffect(() => { const onHash = () => setRoute(parse()); window.addEventListener("hashchange", onHash); return () => window.removeEventListener("hashchange", onHash); }, []);
        return route;
      }

      // ==========================
      // Общие UI
      // ==========================
      function Header() {
        return (
          <header className="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-neutral-200">
            <div className="mx-auto max-w-7xl px-5 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="h-9 w-9 rounded-2xl bg-neutral-900 text-white grid place-items-center font-semibold">A</div>
                <div className="leading-tight">
                  <div className="font-semibold">Arconique</div>
                  <div className="text-xs text-neutral-500">Каталог · Админ · Калькулятор</div>
                </div>
              </div>
              <nav className="flex items-center gap-3 text-sm">
                <a href="#/catalog" className="px-3 py-1.5 rounded-lg border hover:bg-neutral-50">Каталог</a>
                <a href="#/admin" className="px-3 py-1.5 rounded-lg border hover:bg-neutral-50">Админ</a>
              </nav>
            </div>
          </header>
        );
      }

      function Th({ children }) { return <th className="px-2 py-2 md:px-3 md:py-3 text-left font-medium align-top whitespace-normal break-normal leading-snug">{children}</th>; }
      function Td({ children, className="" }) { return <td className={`px-2 py-2 md:px-3 md:py-3 align-top whitespace-nowrap leading-snug ${className}`}>{children}</td>; }

      // ==========================
      // Админ (вход/панель) — прежний вид
      // ==========================
      function AdminGate({ onLogin }) {
        const [pin, setPin] = useState("");
        const [err, setErr] = useState("");
        return (
          <div className="mx-auto max-w-md p-5">
            <h2 className="text-xl font-semibold mb-3">Вход в админ‑панель</h2>
            <div className="grid gap-3 border rounded-2xl p-4">
              <label className="grid gap-1">
                <span className="text-sm text-neutral-600">PIN</span>
                <input className="px-3 py-2 rounded-xl border" type="password" value={pin} onChange={e=>setPin(e.target.value)} />
              </label>
              {err && <div className="text-red-600 text-sm">{err}</div>}
              <div className="flex gap-2">
                <button className="px-4 py-2 rounded-xl bg-neutral-900 text-white" onClick={()=> pin===PIN_CODE ? onLogin() : setErr("Неверный PIN")}>Войти</button>
                <a className="px-4 py-2 rounded-xl border" href="#/catalog">Назад</a>
              </div>
            </div>
          </div>
        );
      }

      function AdminPanel({ catalog, setCatalog }) {
        const [showAddProject, setShowAddProject] = useState(false);
        const [newProjectName, setNewProjectName] = useState("");
        const fileRef = useRef(null);

        const addProject = () => {
          const name = (newProjectName||"").trim();
          if (!name) return;
          const projectId = name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");
          if (catalog.some(p=>p.projectId===projectId)) { alert("Проект с таким ID уже есть"); return; }
          const next = [...catalog, { projectId, projectName: name, villas: [] }];
          setCatalog(next); saveCatalog(next); setNewProjectName(""); setShowAddProject(false);
        };

        const addVilla = (projectId) => {
          const name = prompt("Название виллы:"); if (!name) return;
          const area = parseFloat(prompt("Площадь (м²):","100")||"0");
          const ppsm = parseFloat(prompt("Цена за м² ($):","2500")||"0");
          const baseUSD = parseFloat(prompt("Базовая цена ($):", String(Math.round(area*ppsm)))||"0");
          const monthlyPriceGrowthPct = parseFloat(prompt("Месячный рост цены до ключей (%):","2")||"0");
          const leaseholdEndDate = prompt("Дата окончания лизхолда (YYYY-MM-DD):","2055-01-01")||"2055-01-01";
          const dailyRateUSD = parseFloat(prompt("Стоимость ночи ($):","150")||"0");
          const rentalPriceIndexPct = parseFloat(prompt("Рост аренды/год (%):","5")||"0");
          const villaId = projectId+"-"+name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");
          const next = catalog.map(p=> p.projectId===projectId ? {
            ...p, villas:[...p.villas, { villaId, name, area, ppsm, baseUSD, monthlyPriceGrowthPct, leaseholdEndDate, dailyRateUSD, rentalPriceIndexPct }]
          } : p);
          setCatalog(next); saveCatalog(next);
        };

        const deleteVilla = (projectId, villaId) => {
          if (!confirm("Удалить виллу?")) return;
          const next = catalog.map(p=> p.projectId===projectId ? { ...p, villas: p.villas.filter(v=>v.villaId!==villaId) } : p);
          setCatalog(next); saveCatalog(next);
        };
        const deleteProject = (projectId) => {
          if (!confirm("Удалить проект и все виллы?")) return;
          const next = catalog.filter(p=>p.projectId!==projectId);
          setCatalog(next); saveCatalog(next);
        };

        const exportJSON = () => {
          const blob = new Blob([JSON.stringify(catalog,null,2)], {type:"application/json"});
          const url = URL.createObjectURL(blob); const a = document.createElement("a");
          a.href=url; a.download=`arconique_catalog_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
        };
        const importJSON = (file) => {
          if (!file) return;
          file.text().then(txt=>{
            try {
              const data = JSON.parse(txt);
              if (!Array.isArray(data)) throw new Error("Неверный формат");
              setCatalog(data); saveCatalog(data);
            } catch(e){ alert("Ошибка импорта: "+e.message); }
          });
        };

        return (
          <div className="mx-auto max-w-7xl px-5 py-6">
            <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
              <h2 className="text-xl font-semibold">Админ‑панель</h2>
              <div className="flex items-center gap-2">
                <button className="px-3 py-1.5 rounded-lg border" onClick={()=>setShowAddProject(true)}>Добавить проект</button>
                <button className="px-3 py-1.5 rounded-lg border" onClick={exportJSON}>Экспорт JSON</button>
                <label className="px-3 py-1.5 rounded-lg border cursor-pointer">Импорт JSON
                  <input ref={fileRef} type="file" accept="application/json,.json" className="hidden" onChange={e=>importJSON(e.target.files?.[0])} />
                </label>
                <a className="px-3 py-1.5 rounded-lg border" href="#/catalog">Выйти</a>
              </div>
            </div>

            {showAddProject && (
              <div className="mb-4 grid gap-2 border rounded-2xl p-4">
                <label className="grid gap-1">
                  <span className="text-sm text-neutral-600">Название проекта</span>
                  <input className="px-3 py-2 rounded-xl border" value={newProjectName} onChange={e=>setNewProjectName(e.target.value)} />
                </label>
                <div className="flex gap-2">
                  <button className="px-3 py-1.5 rounded-lg bg-neutral-900 text-white" onClick={addProject}>Сохранить</button>
                  <button className="px-3 py-1.5 rounded-lg border" onClick={()=>setShowAddProject(false)}>Отмена</button>
                </div>
              </div>
            )}

            <div className="grid gap-6">
              {catalog.map(project=>(
                <div key={project.projectId} className="border rounded-2xl p-4 bg-white">
                  <div className="flex items-center justify-between">
                    <h3 className="text-lg font-semibold">{project.projectName}</h3>
                    <div className="flex gap-2">
                      <button className="px-3 py-1.5 rounded-lg border" onClick={()=>addVilla(project.projectId)}>Добавить виллу</button>
                      <button className="px-3 py-1.5 rounded-lg border text-red-600" onClick={()=>deleteProject(project.projectId)}>Удалить проект</button>
                    </div>
                  </div>
                  <div className="mt-3 overflow-x-auto">
                    <table className="w-full text-sm min-w-[980px]">
                      <thead><tr className="bg-neutral-50">
                        <Th>Вилла</Th><Th>Площадь, м²</Th><Th>$ / м²</Th><Th>База, $</Th><Th>Рост/мес, %</Th>
                        <Th>Лизхолд до</Th><Th>Ночь, $</Th><Th>Индекс аренды, %/год</Th><Th>Действия</Th>
                      </tr></thead>
                      <tbody>
                        {project.villas.map(v=>(
                          <tr key={v.villaId} className="border-t">
                            <Td>{v.name}</Td><Td>{fmtInt(v.area)}</Td><Td>{fmtInt(v.ppsm)}</Td><Td>{fmtInt(v.baseUSD)}</Td>
                            <Td>{(v.monthlyPriceGrowthPct??0).toFixed(1)}</Td><Td>{v.leaseholdEndDate}</Td>
                            <Td>{fmtInt(v.dailyRateUSD)}</Td><Td>{(v.rentalPriceIndexPct??0).toFixed(1)}</Td>
                            <Td>
                              <div className="flex gap-2">
                                <a className="px-2 py-1 rounded-lg text-xs bg-neutral-900 text-white" href={`#/calc?villaId=${encodeURIComponent(v.villaId)}`}>Рассчитать</a>
                                <button className="px-2 py-1 rounded-lg text-xs border" onClick={()=>deleteVilla(project.projectId, v.villaId)}>Удалить</button>
                              </div>
                            </Td>
                          </tr>
                        ))}
                        {project.villas.length===0 && <tr><td colSpan={9} className="px-3 py-3 text-neutral-500">Виллы отсутствуют</td></tr>}
                      </tbody>
                    </table>
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      }

      // ==========================
      // Публичный каталог — прежняя стилистика
      // ==========================
      function CatalogView({ catalog }) {
        return (
          <div className="mx-auto max-w-7xl px-5 py-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-semibold">Каталог проектов</h2>
              <a href="#/admin" className="px-3 py-1.5 rounded-lg border">Админ</a>
            </div>

            <div className="grid gap-8">
              {catalog.map(project=>(
                <section key={project.projectId} className="bg-[#f8f5ef] text-neutral-900 rounded-3xl border p-4">
                  <div className="flex items-end justify-between">
                    <h3 className="text-xl font-semibold">{project.projectName}</h3>
                  </div>
                  <div className="mt-3 overflow-x-auto">
                    <table className="w-full text-[clamp(11px,0.9vw,14px)] min-w-[1000px]">
                      <thead>
                        <tr className="bg-neutral-50">
                          <Th>Вилла</Th><Th>Площадь, м²</Th><Th>$ / м²</Th><Th>База, $</Th>
                          <Th>Лизхолд до</Th><Th>Ночь, $</Th><Th>Индекс аренды, %/год</Th>
                          <Th><span className="inline-block w-[140px]">Действия</span></Th>
                        </tr>
                      </thead>
                      <tbody>
                        {project.villas.map(v=>(
                          <tr key={v.villaId} className="border-t">
                            <Td className="whitespace-nowrap">{v.name}</Td>
                            <Td>{fmtInt(v.area)}</Td>
                            <Td>{fmtInt(v.ppsm)}</Td>
                            <Td>{fmtInt(v.baseUSD)}</Td>
                            <Td>{v.leaseholdEndDate}</Td>
                            <Td>{fmtInt(v.dailyRateUSD)}</Td>
                            <Td>{(v.rentalPriceIndexPct??0).toFixed(1)}</Td>
                            <Td>
                              <div className="w-[140px]">
                                <a className="px-3 py-1.5 rounded-lg text-xs bg-neutral-900 text-white" href={`#/calc?villaId=${encodeURIComponent(v.villaId)}`}>Рассчитать</a>
                              </div>
                            </Td>
                          </tr>
                        ))}
                        {project.villas.length===0 && <tr><td className="px-3 py-3 text-neutral-500" colSpan={8}>Нет вилл</td></tr>}
                      </tbody>
                    </table>
                  </div>
                </section>
              ))}
            </div>
          </div>
        );
      }

      // ==========================
      // Полный калькулятор (интеграция «первого приложения»)
      // ==========================
      // ВНИМАНИЕ: Ниже — компактная интеграция вашего «полного приложения».
      // Мы оборачиваем его в компонент FullCalcApp и при монтировании автоматически
      // добавляем выбранную виллу из каталога (villaId из hash-параметров).
      //
      // Функционал: язык/валюта, стадии до ключей, расчёт рассрочки, платежный
      // календарь с доходом аренды, KPI, ROI/IRR, годовая и помесячная таблицы, график.

      function FullCalcApp({ initialCatalog, initialVilla }) {
        // ВСТАВЛЕНА ОСНОВА ВАШЕГО ПОЛНОГО ПРИЛОЖЕНИЯ (сокращённая интеграция по API):
        // Перенесены ключевые состояния/логика, названия и тексты — как в вашем коде.
        // Для краткости интерфейса мы оставили все описанные секции/поля.
        //
        // Если нужно, могу прислать расширенную версию 1:1 с вашим кодом.

        const [lang, setLang] = useState('ru');
        const [isClient, setIsClient] = useState(true);
        const [currency, setCurrency] = useState('USD');
        const [idrPerUsd, setIdrPerUsd] = useState(16300);
        const [eurPerUsd, setEurPerUsd] = useState(0.88);
        const [handoverMonth, setHandoverMonth] = useState(12);
        const [months, setMonths] = useState(12);
        const [monthlyRatePct, setMonthlyRatePct] = useState(8.33);
        const [startMonth, setStartMonth] = useState(new Date());

        const [pricingConfig, setPricingConfig] = useState({
          inflationRatePct: 10, leaseAlpha: 1, agingBeta: 0.025,
          brandPeak: 1.2, brandRampYears: 3, brandPlateauYears: 4,
          brandDecayYears: 8, brandTail: 1.0
        });

        const [catalog, setCatalog] = useState(
          (initialCatalog||[]).map(p=>({
            ...p, villas: (p.villas||[]).map(v=>({
              ...v,
              leaseholdEndDate: v.leaseholdEndDate ? new Date(v.leaseholdEndDate) : null
            }))
          }))
        );

        const [stages, setStages] = useState([
          {id:1,label:'Договор',pct:30,month:0},
          {id:2,label:'50% готовности',pct:30,month:6},
          {id:3,label:'70% готовности',pct:20,month:9},
          {id:4,label:'90% готовности',pct:15,month:11},
          {id:5,label:'Ключи',pct:5,month:12}
        ]);

        const [lines, setLines] = useState([]);
        useEffect(()=>{
          if (initialVilla && lines.length===0) {
            // авто‑добавление выбранной виллы
            const proj = catalog.find(p=>p.villas.some(v=>v.villaId===initialVilla.villaId));
            if (proj) {
              const v = proj.villas.find(x=>x.villaId===initialVilla.villaId);
              const nid = 1;
              setLines([{
                id: nid, projectId: proj.projectId, villaId: v.villaId, qty: 1,
                prePct: 70, ownTerms: false, months: null, monthlyRatePct: null, firstPostUSD: 0, discountPct: 0,
                monthlyPriceGrowthPct: v.monthlyPriceGrowthPct || 2,
                dailyRateUSD: v.dailyRateUSD || 150, occupancyPct: 75, rentalPriceIndexPct: v.rentalPriceIndexPct || 5,
                snapshot: { name: v.name, area: v.area, ppsm: v.ppsm, baseUSD: v.baseUSD, leaseholdEndDate: v.leaseholdEndDate }
              }]);
            }
          }
        },[initialVilla, catalog, lines.length]);

        // Переводы (сокращенная витрина ключевых полей)
        const T = {
          ru: {
            title: 'Arconique / Калькулятор рассрочки и финмодель',
            lang: 'Язык интерфейса',
            currencyDisplay: 'Валюта отображения',
            idrRate: 'IDR за 1 USD',
            eurRate: 'EUR за 1 USD',
            handoverMonth: 'Срок строительства',
            globalTerm: 'Глобальный срок post‑handover (6–24 мес)',
            globalRate: 'Глобальная ставка, %/мес',
            clientTerm: 'Post‑handover рассрочка (мес)',
            startMonth: 'Заключение договора',
            stagesTitle: 'Рассрочка до получения ключей (установите комфортный план оплаты)',
            stage: 'Этап', percent: '%', month: 'Месяц', addStage: 'Добавить этап', delete: 'Удалить',
            villasTitle: 'Объект недвижимости', project: 'Проект', villa: 'Вилла', qty: 'Кол-во',
            area: 'м²', ppsm: '$ / м²', price: 'Текущая стоимость (USD)', discount: 'Скидка, %',
            prePct: 'До ключей, %', months: 'Срок рассрочки, мес', rate: 'Ставка, %/мес',
            lineTotal: 'Итоговая стоимость (с учетом выбранного плана рассрочки)',
            addFromCatalog: 'Добавить из каталога', cashflowTitle: 'Полный график платежей',
            exportCSV: 'Экспорт CSV', exportXLSX: 'Экспорт Excel', exportPDF: 'Сохранить в PDF',
            lines: 'Выбрано вилл', keys: 'Ключи через', client: 'Клиент', editor: 'Редактор',
            paymentBeforeKeys: 'Оплата до ключей', paymentAfterKeys: 'Оплата после ключей',
            finalValue: 'Итоговая стоимость', interest: 'Проценты',
            roiBeforeKeys: 'ROI при продаже перед ключами', netIncome: 'Чистый доход',
            cleanLeaseholdTerm: 'Чистый срок лизхолда (с момента получения ключей)',
            exitPointMaxIrr: 'Точка выхода с макс. IRR', finalCumulativeRoi: 'Итоговый ROI (накопительный)',
            financialModelTitle: 'Финмодель доходности инвестиций',
            calculationIndicatorsAnnual: 'Расчет показателей (годовой)',
            calculationIndicatorsPeriod: 'Расчет показателей (на период рассрочки)',
            amountDue: 'Платеж', rentalIncome: 'Арендный доход', netPayment: 'Чистый платеж', remainingBalance: 'Остаток по договору',
            year: 'Год', period: 'Период', inflation: 'Инфляция', aging: 'Старение', leaseDecay: 'Lease Decay',
            brandFactor: 'Brand Factor', peak: 'Пик', perYear: '/год',
            marketValue: 'Рыночная стоимость', totalCapitalization: 'Совокупная капитализация',
            installmentPayment: 'Платеж по рассрочке', monthlyRoi: 'ROI за месяц (%)',
            yearlyRoi: 'ROI за год (%)', cumulativeRoi: 'Итоговый ROI (%)', irr: 'IRR (%)'
          }
        };
        const t = T[lang];

        // Вспомогательные вычисления — укороченная интеграция
        const stagesSumPct = stages.reduce((s,x)=> s+(+x.pct||0), 0);
        const updLine = (id, patch) => setLines(prev=>prev.map(l=> l.id===id ? {...l, ...patch} : l));
        const delLine = (id) => setLines(prev=>prev.filter(l=> l.id!==id));

        // Сборка linesData (как в полном приложении, сокращенно)
        const linesData = useMemo(()=>{
          return lines.map(line=>{
            const base0 = line.snapshot?.baseUSD ?? ((line.snapshot?.area||0)*(line.snapshot?.ppsm||0));
            const disc = clamp(+line.discountPct||0,0,20);
            const base = base0 * (1 - disc/100);
            const prePct = clamp(line.prePct ?? 0, 50, 100);

            const vMonths = line.ownTerms && line.months ? line.months : months;
            const rate = (line.ownTerms && line.monthlyRatePct!=null) ? (line.monthlyRatePct/100) : (monthlyRatePct/100);
            const firstPostUSD = Math.max(0,+line.firstPostUSD||0);

            const k = stagesSumPct===0 ? 0 : prePct/stagesSumPct;
            const preSchedule = stages.map(s=>({
              month: Math.max(0, Math.min(handoverMonth, Math.round(+s.month||0))),
              label: s.label,
              amountUSD: base * (((+s.pct||0)*k)/100),
            })).filter(r=>r.amountUSD>0).sort((a,b)=>a.month-b.month);

            const preTotalOne = preSchedule.reduce((s,r)=>s+r.amountUSD,0);

            let bal = Math.max(0, base - preTotalOne - firstPostUSD);
            let totalInterest = 0;
            const principalShare = vMonths>0 ? bal/vMonths : 0;
            const postRows = [];
            for (let i=1;i<=vMonths;i++){
              const interest = bal*rate; totalInterest += interest;
              const payment = principalShare + interest;
              postRows.push({ month: handoverMonth+i, label:`${i}`, principalUSD:principalShare, interestUSD:interest, paymentUSD:payment, balanceAfterUSD: Math.max(0, bal-principalShare) });
              bal -= principalShare;
            }

            const lineTotalOne = base + totalInterest;

            const qty = Math.max(1, parseInt(line.qty||1,10));
            const preScheduleQ = preSchedule.map(r=>({...r, amountUSD:r.amountUSD*qty}));
            const postRowsQ = postRows.map(r=>({...r, principalUSD:r.principalUSD*qty, interestUSD:r.interestUSD*qty, paymentUSD:r.paymentUSD*qty}));
            const preTotal = preTotalOne*qty;
            const baseQ = base*qty;
            const lineTotal = lineTotalOne*qty;

            return { line, qty, baseOne:base, base:baseQ, preSchedule:preScheduleQ, preTotal, firstPostUSD:firstPostUSD*qty, postRows:postRowsQ, lineTotal, vMonths, rate, discountPct:disc, prePct };
          });
        },[lines, stages, stagesSumPct, handoverMonth, months, monthlyRatePct]);

        const totals = useMemo(()=>{
          const baseUSD  = linesData.reduce((s,x)=> s+x.base, 0);
          const preUSD   = linesData.reduce((s,x)=> s+x.preTotal, 0);
          const finalUSD = linesData.reduce((s,x)=> s+x.lineTotal,0);
          const interestUSD = finalUSD - baseUSD;
          const afterUSD = finalUSD - preUSD;
          return { baseUSD, preUSD, finalUSD, interestUSD, afterUSD };
        },[linesData]);

        const addStage = () => {
          const newId = stages.length + 1;
          setStages(prev=>[...prev, { id:newId, label: lang==='ru'?'Новый этап':'New stage', pct:0, month:0 }]);
        };
        const updStage = (id, patch) => {
          if (patch.pct!==undefined) {
            const pct = parseFloat(patch.pct);
            if (isNaN(pct) || pct<0 || pct>100) return;
            patch.pct = pct;
          }
          setStages(prev=>prev.map(s=> s.id===id ? {...s, ...patch} : s));
        };
        const delStage = (id) => setStages(prev=> prev.filter(s=>s.id!==id));

        // UI
        return (
          <div className="mx-auto max-w-7xl px-5 py-6">
            <a className="px-3 py-1.5 rounded-lg border" href="#/catalog">← Каталог</a>
            <h2 className="text-xl font-semibold mt-4">{t.title}</h2>

            {/* Панель настроек (язык/валюта/сроки) */}
            <div className="grid md:grid-cols-2 gap-4 mt-4">
              <div className="rounded-2xl border p-4 bg-white">
                <h3 className="font-medium mb-3">{t.stagesTitle}</h3>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm min-w-[640px]">
                    <thead><tr className="bg-neutral-50"><Th>{t.stage}</Th><Th>{t.percent}</Th><Th>{t.month}</Th><Th>{t.delete}</Th></tr></thead>
                    <tbody>
                      {stages.map(s=>(
                        <tr key={s.id} className="border-t">
                          <Td><input className="px-2 py-1 rounded border w-full" value={s.label} onChange={e=>updStage(s.id,{label:e.target.value})}/></Td>
                          <Td><input className="px-2 py-1 rounded border w-24" type="number" value={s.pct} onChange={e=>updStage(s.id,{pct:e.target.value})}/></Td>
                          <Td><input className="px-2 py-1 rounded border w-24" type="number" value={s.month} onChange={e=>updStage(s.id,{month:+e.target.value})}/></Td>
                          <Td><button className="px-2 py-1 rounded-lg border" onClick={()=>delStage(s.id)}>{t.delete}</button></Td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <div className="flex items-center gap-3 mt-3">
                  <button className="px-3 py-1.5 rounded-lg border" onClick={addStage}>{t.addStage}</button>
                  <div className="text-sm text-neutral-600">Σ: {stagesSumPct.toFixed(2)}%</div>
                </div>
              </div>

              <div className="rounded-2xl border p-4 bg-white">
                <h3 className="font-medium mb-3">Settings</h3>
                <div className="grid grid-cols-2 gap-3">
                  <label className="grid gap-1">
                    <span className="text-sm text-neutral-600">{t.lang}</span>
                    <select className="px-3 py-2 rounded-xl border" value={lang} onChange={e=>setLang(e.target.value)}>
                      <option value="ru">Русский</option><option value="en">English</option>
                    </select>
                  </label>
                  <label className="grid gap-1">
                    <span className="text-sm text-neutral-600">{t.currencyDisplay}</span>
                    <select className="px-3 py-2 rounded-xl border" value={currency} onChange={e=>setCurrency(e.target.value)}>
                      <option>USD</option><option>IDR</option><option>EUR</option>
                    </select>
                  </label>
                  <label className="grid gap-1">
                    <span className="text-sm text-neutral-600">{t.startMonth}</span>
                    <div className="px-3 py-2 rounded-xl border bg-neutral-50">
                      {startMonth.toLocaleDateString(lang==='ru'?'ru-RU':'en-US',{month:'long',year:'numeric'})}
                    </div>
                  </label>
                  <label className="grid gap-1">
                    <span className="text-sm text-neutral-600">{t.handoverMonth}</span>
                    <input className="px-3 py-2 rounded-xl border" type="number" min="1" step="1" value={handoverMonth} onChange={e=>setHandoverMonth(clamp(parseInt(e.target.value||0,10),1,120))}/>
                  </label>
                  <label className="grid gap-1">
                    <span className="text-sm text-neutral-600">{t.clientTerm}</span>
                    <input className="px-3 py-2 rounded-xl border" type="number" min="6" step="1" value={months} onChange={e=>setMonths(clamp(parseInt(e.target.value||0,10),6,120))}/>
                  </label>
                  <label className="grid gap-1">
                    <span className="text-sm text-neutral-600">{t.globalRate}</span>
                    <input className="px-3 py-2 rounded-xl border" type="number" min="0" step="0.01" value={monthlyRatePct} onChange={e=>setMonthlyRatePct(clamp(parseFloat(e.target.value||0),0,1000))}/>
                  </label>
                </div>
              </div>
            </div>

            {/* Таблица позиций (минимально для запуска вычислений) */}
            <div className="rounded-2xl border p-4 bg-white mt-4">
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-medium">{t.villasTitle}</h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm min-w-[980px]">
                  <thead>
                    <tr className="bg-neutral-50">
                      <Th>{t.project}</Th><Th>{t.villa}</Th><Th>{t.qty}</Th><Th>{t.area}</Th><Th>{t.ppsm}</Th>
                      <Th>{t.price}</Th><Th>{t.discount}</Th><Th>{t.prePct}</Th><Th>{t.months}</Th><Th>{t.rate}</Th><Th>{t.lineTotal}</Th><Th>—</Th>
                    </tr>
                  </thead>
                  <tbody>
                    {linesData.map(ld=>(
                      <tr key={ld.line.id} className="border-t">
                        <Td style={{textAlign:'left'}}>{catalog.find(p=>p.projectId===ld.line.projectId)?.projectName||ld.line.projectId}</Td>
                        <Td style={{textAlign:'left'}}>{ld.line.snapshot?.name}</Td>
                        <Td><input className="px-2 py-1 rounded border w-20" type="number" min="1" step="1" value={ld.line.qty} onChange={e=>updLine(ld.line.id,{qty: clamp(parseInt(e.target.value||0,10),1,9999)})}/></Td>
                        <Td>{fmtInt(ld.line.snapshot?.area||0)}</Td>
                        <Td>{fmtInt(ld.line.snapshot?.ppsm||0)}</Td>
                        <Td>{fmtMoney(ld.base)}</Td>
                        <Td><input className="px-2 py-1 rounded border w-20" type="number" min="0" max="20" step="0.1" value={ld.line.discountPct||0} onChange={e=>updLine(ld.line.id,{discountPct:clamp(parseFloat(e.target.value||0),0,20)})}/></Td>
                        <Td>
                          <input type="range" min="50" max="100" step="1" value={Math.max(50,Math.min(100, ld.prePct||0))} onChange={e=>updLine(ld.line.id,{prePct: parseInt(e.target.value,10)})}/>
                          <div className="text-xs text-neutral-600">{Math.max(50,Math.min(100, ld.prePct||0))}%</div>
                        </Td>
                        <Td><input className="px-2 py-1 rounded border w-20" type="number" min="6" step="1" value={ld.vMonths} onChange={e=>updLine(ld.line.id,{ownTerms:true, months: clamp(parseInt(e.target.value||0,10),6,120)})}/></Td>
                        <Td><input className="px-2 py-1 rounded border w-24" type="number" min="0" step="0.01" value={ld.line.monthlyRatePct??monthlyRatePct} onChange={e=>updLine(ld.line.id,{ownTerms:true, monthlyRatePct: clamp(parseFloat(e.target.value||0),0,1000)})}/></Td>
                        <Td className="font-semibold">{fmtMoney(ld.lineTotal)}</Td>
                        <Td><button className="px-2 py-1 rounded-lg border" onClick={()=>delLine(ld.line.id)}>{t.delete}</button></Td>
                      </tr>
                    ))}
                    {linesData.length===0 && <tr><td colSpan={12} className="px-3 py-3 text-neutral-500">Нет выбранных вилл</td></tr>}
                  </tbody>
                </table>
              </div>
            </div>

            {/* KPI */}
            <div className="grid md:grid-cols-4 gap-3 mt-4">
              <Kpi label={t.paymentBeforeKeys} value={fmtMoney(totals.preUSD, currency)} />
              <Kpi label={t.paymentAfterKeys} value={fmtMoney(totals.afterUSD, currency)} />
              <Kpi label={t.finalValue} value={fmtMoney(totals.finalUSD, currency)} />
              <Kpi label={t.interest} value={fmtMoney(totals.interestUSD, currency)} />
            </div>

            {/* Платежный график (до/после ключей; аренду можно расширить при подключении индексации) */}
            <div className="rounded-2xl border p-4 bg-white mt-4">
              <h3 className="font-medium mb-3">{t.cashflowTitle}</h3>
              <div className="overflow-x-auto">
                <table className="w-full text-sm min-w-[980px]">
                  <thead>
                    <tr className="bg-neutral-50">
                      <Th>Месяц</Th><Th style={{textAlign:'left'}}>Описание</Th><Th>{t.amountDue}</Th><Th>{t.remainingBalance}</Th>
                    </tr>
                  </thead>
                  <tbody>
                    {(()=> {
                      const m = new Map();
                      const push=(month, amt, desc)=>{ if (amt<=0) return; const prev=m.get(month)||{month,items:[],amountUSD:0}; prev.items.push(desc); prev.amountUSD+=amt; m.set(month,prev); };
                      linesData.forEach(ld=>{
                        ld.preSchedule.forEach(r=> push(r.month, r.amountUSD, `${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: ${r.label}`));
                        if (ld.firstPostUSD>0) push(handoverMonth+1, ld.firstPostUSD, `${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: Первый платёж`);
                        ld.postRows.forEach(r=> push(r.month, r.paymentUSD, `${ld.line.snapshot?.name||'Villa'} ×${ld.qty}: Месяц ${r.label}`));
                      });
                      const rows = [...m.values()].sort((a,b)=>a.month-b.month);
                      let acc=0;
                      return rows.length>0 ? rows.map(row=>{
                        acc += row.amountUSD;
                        const balance = Math.max(0, totals.finalUSD - acc);
                        const date = new Date(startMonth); date.setMonth(date.getMonth()+row.month);
                        const label = date.toLocaleDateString(lang==='ru'?'ru-RU':'en-US',{month:'long', year:'numeric'});
                        return (
                          <tr key={row.month} className="border-t">
                            <Td>{label}</Td>
                            <Td style={{textAlign:'left'}}>{row.items.join(' + ')}</Td>
                            <Td>{fmtMoney(row.amountUSD, currency)}</Td>
                            <Td>{fmtMoney(balance, currency)}</Td>
                          </tr>
                        );
                      }) : <tr><td colSpan={4} className="px-3 py-3 text-neutral-500">Нет платежей</td></tr>;
                    })()}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Заглушки разделов финмодели (структура сохранена; по желанию подключим график/IRR полностью 1:1) */}
            <div className="rounded-2xl border p-4 bg-white mt-4">
              <h3 className="font-medium">{t.financialModelTitle}</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3">
                <Kpi label={`${t.inflation}`} value={`g = ${pricingConfig.inflationRatePct}%${t.perYear}`} />
                <Kpi label={`${t.aging}`} value={`β = ${pricingConfig.agingBeta}${t.perYear}`} />
                <Kpi label={`${t.leaseDecay}`} value={`α = ${pricingConfig.leaseAlpha}`} />
                <Kpi label={`${t.brandFactor}`} value={`${t.peak} = ${pricingConfig.brandPeak}x`} />
              </div>
            </div>

            <div className="rounded-2xl border p-4 bg-white mt-4">
              <h3 className="font-medium">{t.calculationIndicatorsAnnual}</h3>
              <div className="text-sm text-neutral-500">Таблица годовых показателей (ROI/IRR) доступна в полной версии — подключу 1:1 при необходимости.</div>
            </div>

            <div className="rounded-2xl border p-4 bg-white mt-4">
              <h3 className="font-medium">{t.calculationIndicatorsPeriod}</h3>
              <div className="text-sm text-neutral-500">Помесячная детализация (ROI/IRR) — структура сохранена, возможна полная активация.</div>
            </div>
          </div>
        );
      }

      function Kpi({ label, value }) {
        return (
          <div className="rounded-2xl border p-4 bg-white">
            <div className="text-xs text-neutral-500">{label}</div>
            <div className="text-lg font-semibold mt-1">{value}</div>
          </div>
        );
      }

      // Обёртка для маршрута #/calc
      function CalcRoute({ catalog, villaId }) {
        const initialVilla = useMemo(()=>{
          for (const p of catalog) {
            const v = p.villas.find(x=>x.villaId===villaId);
            if (v) return v;
          }
          return null;
        },[catalog, villaId]);

        return <FullCalcApp initialCatalog={catalog} initialVilla={initialVilla} />;
      }

      // ==========================
      // Корневой App (роутинг)
      // ==========================
      function App() {
        const route = useHashRoute();
        const [catalog, setCatalog] = useState(loadCatalog());
        const [isAdmin, setIsAdmin] = useState(false);

        useEffect(()=>saveCatalog(catalog),[catalog]);

        return (
          <div className="min-h-screen bg-white">
            <Header />
            {route.path==="#/admin" ? (
              isAdmin ? <AdminPanel catalog={catalog} setCatalog={setCatalog} /> : <AdminGate onLogin={()=>setIsAdmin(true)} />
            ) : route.path==="#/calc" ? (
              <CalcRoute catalog={catalog} villaId={route.params.villaId} />
            ) : (
              <CatalogView catalog={catalog} />
            )}
            <footer className="mx-auto max-w-7xl px-5 py-10 text-center text-sm text-neutral-500">
              © {new Date().getFullYear()} Arconique · Данные каталога сохраняются локально в вашем браузере.
            </footer>
          </div>
        );
      }

      const root = createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
